<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachermath Setup</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
body { 
  font-family: 'Roboto', sans-serif; 
  text-align: center; 
  margin: 0; 
  padding: 20px;
  position: relative;
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}
/* Responsive Design */
/* Mobile: < 768px */
@media (max-width: 767px) {
  body {
    padding: 5px !important;
  }
  h2 {
    font-size: 18px !important;
    margin: 10px 0 !important;
  }
  h3 {
    font-size: 16px !important;
    margin: 10px 0 !important;
  }
  .info-section {
    padding: 10px 15px !important;
    max-width: 95vw !important;
    width: 95vw !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .info-inputs {
    gap: 3px !important;
    flex-direction: column !important;
    width: 100% !important;
    align-items: center !important; /* center children horizontally */
  }
  .info-inputs input {
    width: 100% !important;
    font-size: 13px !important;
    padding: 7px !important;
    box-sizing: border-box !important;
    margin-bottom: 4px !important;
  }
  /* make the week input (first child) narrower and centered on mobile */
  .info-inputs input:nth-child(1) {
    width: 140px !important;
    max-width: 60% !important;
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container {
    padding: 6px !important;
    max-width: 98vw !important;
    width: 98vw !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .main-container input {
    font-size: 14px !important;
    padding: 7px !important;
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 4px !important;
  }
  .main-container label {
    font-size: 12px !important;
  }
  .main-container > div[style*="display:flex"] {
    flex-direction: column !important;
    gap: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div {
    width: 100% !important;
    padding: 6px !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
    margin: 0 2px !important;
  }
  .main-container > div[style*="display:flex"] > div input {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  .neon-btn {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 35px !important;
    width: auto !important; /* don't stretch full width on mobile */
    max-width: 320px !important;
    margin: 8px auto !important; /* center horizontally */
    box-sizing: border-box !important;
  }
  .image-preview-item {
    width: 90px !important;
    height: 90px !important;
  }
}

/* Tablet: 768px - 1024px */
@media (min-width: 768px) and (max-width: 1024px) {
  .info-section {
    max-width: 90vw !important;
    width: 90vw !important;
  }
  .main-container {
    max-width: 92vw !important;
    width: 92vw !important;
  }
  .info-inputs input:nth-child(1) {
    width: 100px !important;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 150px !important;
  }
  .image-preview-item {
    width: 110px !important;
    height: 110px !important;
  }
}

/* Desktop: > 1024px */
@media (min-width: 1025px) {
  .info-section {
    max-width: 900px !important;
    width: 100% !important;
  }
  .main-container {
    max-width: 900px !important;
    width: 100% !important;
  }
  .info-inputs input:nth-child(1) {
    width: 120px !important;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 180px !important;
  }
  .image-preview-item {
    width: 120px !important;
    height: 120px !important;
  }
}

body::before {
  content: '';
  position: fixed;
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0;
  background: linear-gradient(to bottom, #ebd09e 0%, #251f03 100%);
  z-index: -1;
}
input, button { font-size:16px; margin:5px; padding:10px; text-transform: lowercase; border-radius:15px; border:2px solid #ccc; }
textarea {
  font-size:16px; margin:5px; padding:10px; width:250px; height:120px; resize:none;
  border:2px solid #ccc; border-radius:15px;
  background: repeating-linear-gradient(
    to bottom,
    #fff,
    #fff 28px,
    #ccc 28px,
    #ccc 30px
  );
  line-height:30px;
  text-transform: lowercase; /* พิมพ์อะไรก็เป็นตัวเล็ก */
}
button { cursor:pointer; }
.image-preview-item {
  display: inline-block;
  margin: 10px;
  position: relative;
  border: 2px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  width: 120px;
  height: 120px;
  background: repeating-conic-gradient(#ddd 0% 25%, transparent 0% 50%) 50% / 20px 20px;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.image-preview-item .remove-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
}
.file-input-wrapper {
  position: relative;
  display: inline-block;
  margin: 10px;
}

/* Neon Button Style */
.neon-btn {
  background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
  color: #000000;
  border: 6px solid #74640a;
  border-radius: 9999px;
  box-shadow: 1px 1px 0 #000, -8px 6px #3b3305, 0 0 20px rgba(255,230,160,0.55);
  font-weight: 700;
  font-size: clamp(1rem, 2vw, 1.5rem);
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  padding: clamp(14px, 2.5vw, 20px) clamp(35px, 5vw, 50px);
  transform: translateZ(0);
  transition: all 0.3s ease;
  z-index: 10;
  min-height: 55px;
  display: inline-block;
  cursor: pointer;
  width: auto; /* fit to content on larger screens */
  max-width: 360px; /* prevent overly wide button */
  box-sizing: border-box;
}

.neon-btn:hover {
  transform: translateY(-2px);
  box-shadow: 2px 2px 0 #000, -10px 8px #3b3305, 0 0 25px rgba(255,230,160,0.75);
}
.file-input-label {
  background: #fff8e8;
  color: #333;
  border: 2px dashed #74640a;
  border-radius: 15px;
  font-weight: 500;
  font-size: 16px;
  padding: 12px 24px;
  margin-top: 16px;
  display: inline-block;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
.file-input-label-correct {
  background: #fff !important;
  color: #4CAF50 !important;
  border: 2px solid #4CAF50 !important;
  border-radius: 15px !important;
  font-weight: 500 !important;
  font-size: 16px !important;
  padding: 10px 20px !important;
  margin-top: 16px !important;
  display: inline-block !important;
  cursor: pointer !important;
  transition: background 0.2s, border-color 0.2s !important;
  min-height: 30px !important;
}
.file-input-label-wrong {
  background: #fff !important;
  color: #f44336 !important;
  border: none !important;
  border-radius: 18px !important;
  font-weight: 500 !important;
  font-size: 16px !important;
  padding: 10px 20px !important;
  margin-top: 16px !important;
  display: inline-block !important;
  cursor: pointer !important;
  transition: background 0.2s !important;
  min-height: 30px !important;
}

.file-input-label:hover {
  background: #f5f0e5;
  border-color: #bfa22a;
}
.choice-item {
  background: #f0f0f0;
  padding: 8px;
  margin: 5px 0;
  border-radius: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.choice-item button {
  background: #f44336;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}
.info-section {
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
  margin-bottom: 20px;
  max-width: 900px;
  width: 100%;
}
.main-container {
  max-width: 900px;
  width: 100%;
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
}
.info-inputs {
  display: flex;
  gap: 5px;
  justify-content: center;
  margin: 10px 0 20px 0;
  flex-wrap: wrap;
}
.info-inputs input {
  width: 120px;
  font-size: 16px;
  padding: 10px;
  border-radius: 15px;
}
.info-inputs input:nth-child(1) {
  width: 120px;
}
.info-inputs input:nth-child(2),
.info-inputs input:nth-child(3),
.info-inputs input:nth-child(4) {
  width: 180px;
}
@media (max-width: 767px) {
  .info-inputs {
    gap: 3px;
  }
  .info-inputs input {
    width: calc(50% - 3px) !important;
    font-size: 12px !important;
    padding: 6px !important;
    box-sizing: border-box;
  }
  .neon-btn {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 35px !important;
  }
  .file-input-label {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 30px !important;
    border-radius: 10px !important;
  }
}
@media (min-width: 768px) and (max-width: 1024px) {
  .info-inputs input:nth-child(1) {
    width: 100px;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 150px;
  }
}

/* iPad / large tablet adjustments (reduce size of the green/red panels) */
/* apply on large tablets in both portrait and landscape explicitly */
/* Special case: iPad portrait around 1023px becomes too narrow with smaller-panel rules.
   Provide a gentler rule for widths up to 1024px so portrait doesn't look shrunk. */
@media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important; /* match landscape width */
    max-width: 28% !important;
    padding: 6px !important;
    margin: 6px !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] {
    gap: 10px !important;
    justify-content: center !important;
  }
  /* make the inner area inside the red/green panels larger (user asked about contents inside frames) */
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 68% !important;
    margin: 6px auto !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-label,
  .main-container > div[style*="display:flex"] > div .file-input-label-correct,
  .main-container > div[style*="display:flex"] > div .file-input-label-wrong {
    padding: 7px 10px !important;
    font-size: 13px !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 64px !important;
    height: 64px !important;
    margin: 6px auto !important;
  }
}

@media (min-width: 768px) and (max-width: 1365px) and (orientation: portrait) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important; /* match landscape width */
    max-width: 28% !important;
    padding: 6px !important; /* slightly reduced internal padding */
    margin: 6px !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] {
    gap: 10px !important;
    justify-content: center !important;
  }
  /* Reduce inner content width so items inside the colored frames don't stretch too wide */
  /* Reduce inner content width so items inside the colored frames don't stretch too wide */
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 68% !important;
    margin: 6px auto !important;
    display: block !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-label,
  .main-container > div[style*="display:flex"] > div .file-input-label-correct,
  .main-container > div[style*="display:flex"] > div .file-input-label-wrong {
    max-width: 100% !important;
    display: inline-block !important;
    padding: 7px 10px !important;
    font-size: 13px !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 64px !important;
    height: 64px !important;
    margin: 6px auto !important;
  }
}

@media (min-width: 768px) and (max-width: 1365px) and (orientation: landscape) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important; /* further reduced for landscape */
    max-width: 28% !important;
    padding: 6px !important; /* slightly reduced internal padding */
    margin: 6px !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] {
    gap: 10px !important;
    justify-content: center !important;
  }
  /* Reduce inner content width so items inside the colored frames don't stretch too wide */
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 68% !important;
    margin: 6px auto !important;
    display: block !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-label,
  .main-container > div[style*="display:flex"] > div .file-input-label-correct,
  .main-container > div[style*="display:flex"] > div .file-input-label-wrong {
    max-width: 100% !important;
    display: inline-block !important;
    padding: 7px 10px !important;
    font-size: 13px !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 64px !important;
    height: 64px !important;
    margin: 6px auto !important;
  }
}

/* Safari on iPad specific: tighten gray frames and panels further for better visual fit */
@supports (-webkit-touch-callout: none) {
  /* Safari: make portrait <=1024px match the larger portrait sizing so iPad Safari isn't too small */
  @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
    .info-section, .main-container {
      max-width: 86vw !important;
      width: 86vw !important;
      padding: 12px !important;
    }
    .main-container > div[style*="display:flex"] > div {
      flex: 0 0 36% !important;
      max-width: 36% !important;
      padding: 8px !important;
    }
    .main-container > div[style*="display:flex"] > div .file-input-wrapper {
      max-width: 76% !important;
    }
    .main-container > div[style*="display:flex"] > div .image-preview-item {
      width: 80px !important;
      height: 80px !important;
    }
  }
  /* Portrait iPad Safari */
  @media (min-width: 768px) and (max-width: 1365px) and (orientation: portrait) {
    .info-section, .main-container {
      max-width: 82vw !important;
      width: 82vw !important;
      padding: 12px !important;
    }
    .main-container > div[style*="display:flex"] > div {
      flex: 0 0 36% !important; /* match Safari landscape */
      max-width: 36% !important;
      padding: 8px !important;
    }
    .main-container > div[style*="display:flex"] > div .file-input-wrapper {
      max-width: 76% !important;
    }
    .image-preview-item {
      width: 80px !important;
      height: 80px !important;
    }
  }

  /* Landscape iPad Safari */
  @media (min-width: 768px) and (max-width: 1365px) and (orientation: landscape) {
    .info-section, .main-container {
      max-width: 80vw !important;
      width: 80vw !important;
      padding: 12px !important;
    }
    .main-container > div[style*="display:flex"] > div {
      flex: 0 0 36% !important;
      max-width: 36% !important;
      padding: 8px !important;
    }
    .main-container > div[style*="display:flex"] > div .file-input-wrapper {
      max-width: 76% !important;
    }
    .image-preview-item {
      width: 80px !important;
      height: 80px !important;
    }
  }
}
@media (min-width: 1025px) {
  .info-inputs input:nth-child(1) {
    width: 120px;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 180px;
  }
}

@media (max-width: 767px) {
  .info-section {
    padding: 10px 15px !important;
    max-width: 91% !important;
    width: 91% !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .main-container {
    padding: 6px !important;
    max-width: 91% !important;
    width: 91% !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
}
/* Simple final safety: keep red/green panels from exceeding the trainer/main container
   for both portrait and landscape. This is intentionally conservative and overrides
   earlier tablet rules so nothing hangs outside the container. */
@media (min-width: 768px) {
  .main-container {
    overflow: hidden; /* prevent accidental horizontal overflow */
  }
  .main-container > div[style*="display:flex"] {
    display: flex !important;
    flex-wrap: wrap !important; /* allow wrap on very small widths */
    gap: 12px !important;
    justify-content: center !important;
  }
  .main-container > div[style*="display:flex"] > div {
    box-sizing: border-box !important;
    /* auto-size panels relative to the main container: two columns that adapt */
    flex: 1 1 calc(50% - 12px) !important; /* flexible basis minus gap */
    max-width: calc(50% - 12px) !important;
    min-width: 0 !important; /* allow panels to shrink with container */
    margin: 0 !important;
    padding: 8px !important;
  }
  /* ensure inner controls scale and don't overflow the panel */
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 90% !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-label,
  .main-container > div[style*="display:flex"] > div .file-input-label-correct,
  .main-container > div[style*="display:flex"] > div .file-input-label-wrong {
    white-space: normal !important;
    overflow-wrap: break-word !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    max-width: 120px !important; /* scale but cap size */
    width: 100% !important;
    height: auto !important;
  }
}
/* iPad Pro specific tweaks (11" and 12.9") — make portrait and landscape use the same panel sizing */
/* 11" iPad Pro typical CSS viewport: ~834 x 1194 */
@media (min-width: 820px) and (max-width: 1194px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important;
    max-width: 28% !important;
    padding: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 86% !important;
    margin: 8px auto !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 88px !important;
    height: 88px !important;
  }
}

/* 12.9" iPad Pro typical CSS viewport: ~1024 x 1366 */
@media (min-width: 1024px) and (max-width: 1366px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important;
    max-width: 28% !important;
    padding: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 86% !important;
    margin: 8px auto !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 96px !important;
    height: 96px !important;
  }
}
</style>
</head>
<body>

<div class="info-section">
  <h3>กรอกข้อมูลกิจกรรม</h3>
  <div class="info-inputs">
    <input id="weekInput" placeholder="สัปดาห์ที่">
    <input id="topicInput" placeholder="สาระการเรียนรู้">
    <input id="unitInput" placeholder="หน่วยการเรียนรู้">
    <input id="teacherInput" placeholder="ครูผู้รับผิดชอบ">
  </div>
</div>

<div class="main-container">
  <!-- ลบ section โจทย์เลขและคำตอบคณิตศาสตร์ออก เหลือเฉพาะกรอบอัพโหลดรูปภาพ -->
  <h3 style="margin-top:40px;">เพิ่มรูปภาพ</h3>
  <input id="mainTopicInput" placeholder="หัวข้อกิจกรรม/หมวดหมู่" style="max-width:500px; font-size:18px; padding:12px; border-radius:15px; margin-bottom:20px; background:#fff; border:2px solid #ccc; box-shadow:none; color:#333;"><br>
  <div style="display:flex; gap:5px; justify-content:center; margin-top:20px;">
    <div style="flex:1; background:rgba(76, 175, 80, 0.1); padding:15px; border-radius:10px; border:2px solid #4CAF50;">
      <label style="color:#4CAF50; font-weight:bold;">รูปที่ถูกต้อง ✅</label><br>
      <div class="file-input-wrapper" style="display: flex; justify-content: center; margin-top:10px;">
        <label class="file-input-label file-input-label-correct">เลือกภาพ
          <input type="file" id="correctImageInput" accept="image/*" onchange="handleImageUpload(event, 'correct')">
        </label>
      </div>
      <div id="correctImagesList" style="margin-top:10px;"></div>
    </div>
    <div style="flex:1; background:rgba(244, 67, 54, 0.1); padding:15px; border-radius:10px; border:2px solid #f44336;">
      <label style="color:#f44336; font-weight:bold;">รูปที่ผิด ❌</label><br>
      <div class="file-input-wrapper" style="display: flex; justify-content: center; margin-top:10px;">
        <label class="file-input-label file-input-label-wrong">เลือกภาพ
          <input type="file" id="wrongImageInput" accept="image/*" onchange="handleImageUpload(event, 'wrong')">
        </label>
      </div>
      <div id="wrongImagesList" style="margin-top:10px;"></div>
    </div>
  </div>
</div>
  <button class="neon-btn" onclick="saveConfig()">เริ่มกิจกรรม</button>

<script>
let correctImages = [];
let wrongImages = [];



// ฟังก์ชันจัดการรูปภาพที่อัปโหลด
function handleImageUpload(event, type) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Auto crop to square
      const croppedImageData = autoCropToSquare(img);
      
      // เพิ่มรูปเข้าอาร์เรย์
      if (type === 'correct') {
        correctImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('correct');
      } else {
        wrongImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('wrong');
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ฟังก์ชันปรับขนาดและตัดพื้นหลังอัตโนมัติ
function autoCropToSquare(img) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // กำหนดขนาดสูงสุด
  const maxSize = 300;
  let width = img.width;
  let height = img.height;
  
  // ปรับขนาดถ้ารูปใหญ่เกินไป โดยรักษาสัดส่วน
  if (width > maxSize || height > maxSize) {
    if (width > height) {
      height = (height / width) * maxSize;
      width = maxSize;
    } else {
      width = (width / height) * maxSize;
      height = maxSize;
    }
  }
  
  canvas.width = width;
  canvas.height = height;
  
  // วาดรูปลงบน canvas
  ctx.drawImage(img, 0, 0, width, height);
  
  // ตัดพื้นหลัง
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  
  // หาสีพื้นหลัง (ใช้สีมุม 4 มุม)
  const corners = [
    [0, 0], // มุมซ้ายบน
    [width - 1, 0], // มุมขวาบน
    [0, height - 1], // มุมซ้ายล่าง
    [width - 1, height - 1] // มุมขวาล่าง
  ];
  
  let bgColor = null;
  for (let corner of corners) {
    const x = corner[0];
    const y = corner[1];
    const index = (y * width + x) * 4;
    const r = data[index];
    const g = data[index + 1];
    const b = data[index + 2];
    
    if (r > 200 && g > 200 && b > 200) { // สีขาวหรือใกล้เคียง
      bgColor = { r, g, b };
      break;
    }
  }
  
  // ตัดพื้นหลังออก (ถ้าเจอสีพื้นหลัง)
  if (bgColor) {
    const threshold = 40; // ค่าความต่างของสี
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      
      // ถ้าสีใกล้เคียงกับพื้นหลัง ให้โปร่งใส
      if (Math.abs(r - bgColor.r) < threshold && 
          Math.abs(g - bgColor.g) < threshold && 
          Math.abs(b - bgColor.b) < threshold) {
        data[i + 3] = 0; // ทำให้โปร่งใส
      }
    }
    
    ctx.putImageData(imageData, 0, 0);
  }
  
  // แปลงเป็น base64 (ใช้ PNG เพื่อรักษาความโปร่งใส)
  return canvas.toDataURL('image/png', 0.9);
}

// ฟังก์ชันลบรูปภาพ
function removeImage(type, index) {
  if (type === 'correct') {
    correctImages.splice(index, 1);
    renderImages('correct');
  } else {
    wrongImages.splice(index, 1);
    renderImages('wrong');
  }
}

// ฟังก์ชันแสดงรายการรูปภาพ
function renderImages(type) {
  const listId = type === 'correct' ? 'correctImagesList' : 'wrongImagesList';
  const images = type === 'correct' ? correctImages : wrongImages;
  const list = document.getElementById(listId);
  
  list.innerHTML = images.map((imgData, i) => `
    <div class="image-preview-item">
      <img src="${imgData}" alt="Image ${i+1}">
      <button class="remove-btn" onclick="removeImage('${type}', ${i})">×</button>
    </div>
  `).join('');
}

// โหลด config เก่าถ้ามี
const savedConfig = JSON.parse(localStorage.getItem('emojiGameConfig')||'{}');
if(savedConfig.topic) document.getElementById('topicInput').value = savedConfig.topic;
if(savedConfig.date) document.getElementById('dateInput').value = savedConfig.date;
if(savedConfig.correctImages) correctImages = savedConfig.correctImages;
if(savedConfig.wrongImages) wrongImages = savedConfig.wrongImages;
renderImages('correct');
renderImages('wrong');

// ตั้งค่าวันที่เป็นวันปัจจุบันถ้ายังไม่มี
if(!savedConfig.date) {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').value = today;
}

function saveConfig(){
  const week = document.getElementById('weekInput')?.value.trim();
  const topic = document.getElementById('topicInput')?.value.trim();
  const unit = document.getElementById('unitInput')?.value.trim();
  const teacher = document.getElementById('teacherInput')?.value.trim();
  const mainTopic = document.getElementById('mainTopicInput')?.value.trim();
  // dateInput may not exist, so skip

  if(!week){ alert("กรุณากรอกสัปดาห์ที่"); return; }
  if(!topic){ alert("กรุณากรอกสาระการเรียนรู้"); return; }
  if(!unit){ alert("กรุณากรอกหน่วยการเรียนรู้"); return; }
  if(!teacher){ alert("กรุณากรอกชื่อครูผู้รับผิดชอบ"); return; }
  if(!mainTopic){ alert("กรุณากรอกหัวข้อกิจกรรม/หมวดหมู่"); return; }
  if(correctImages.length === 0){ alert("กรุณาเพิ่มรูปที่ถูกต้องอย่างน้อย 1 รูป"); return; }
  if(wrongImages.length === 0){ alert("กรุณาเพิ่มรูปที่ผิดอย่างน้อย 1 รูป"); return; }

  // Save config
  const config = {
    week: week,
    topic: topic,
    unit: unit,
    teacher: teacher,
    mainTopic: mainTopic,
    correctImages: correctImages,
    wrongImages: wrongImages
  };
  localStorage.setItem('emojiGameConfig', JSON.stringify(config));

  window.location.href='gamepicture.html';
}
</script>

</body>
</html>
